ENV['RACK_ENV'] = 'test'

require_relative '../env'

require 'rake'
require 'standalone_migrations'
require 'rack/csrf'
require 'web/helpers/post_body_content_type_parser'
require 'sinatra/base'
require 'sinatra/config_file'
require 'sinatra/json'
require 'web/extensions/csrf_protection'
require 'web/helpers/options_helper'
require 'web/helpers/web_session_output_helper'
require 'web/models'
require 'web/controllers'
require 'fileutils'
require 'rack/test'
require 'rspec'
require 'shoulda/matchers'
require 'database_cleaner'

require_all 'spec/support'

# Setup test database.
stdout = StringIO.new
$stdout = stdout
StandaloneMigrations::Tasks.load_tasks
Rake::Task['db:environment:set'].invoke('RAILS_ENV=test')
Rake::Task['db:schema:load'].invoke
$stdout = STDOUT

# Helper methods for creating test data.
module ModelHelpers
end

RSpec.configure do |config|
  config.before(:each) do
    Typhoeus::Expectation.clear
  end

  config.include Rack::Test::Methods
  config.include ModelHelpers

  config.before(:suite) do
    DatabaseCleaner.strategy = :transaction
    DatabaseCleaner.clean_with(:truncation, except: %w(ar_internal_metadata))
  end

  config.around(:each) do |example|
    DatabaseCleaner.cleaning do
      example.run
    end
  end

  config.after(:all) do
    Dir.chdir(Dir.tmpdir) do
      temp_directories = Dir.glob('wpxf_*')
      unless temp_directories.empty?
        temp_directories.each { |d| FileUtils.rm_rf(d) }
      end
    end
  end
end

Shoulda::Matchers.configure do |config|
  config.integrate do |with|
    with.test_framework :rspec
    with.library :active_record
    with.library :active_model
  end
end
