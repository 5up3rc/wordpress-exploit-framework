ENV['RACK_ENV'] = 'test'

require 'rake'
require_relative '../db/tasks'
require 'stringio'

# Setup test database.
stdout = StringIO.new
$stdout = stdout
Rake::Task['db:migrate'].invoke
$stdout = STDOUT

require_relative '../env'

require 'rack/csrf'
require 'web/helpers/post_body_content_type_parser'
require 'sinatra/base'
require 'sinatra/config_file'
require 'sinatra/json'
require 'web/extensions/csrf_protection'
require 'web/helpers/options_helper'
require 'web/helpers/web_session_output_helper'
require 'web/models'
require 'web/controllers'
require 'fileutils'
require 'rack/test'
require 'rspec'
require 'rspec_sequel_matchers'
require 'database_cleaner'

require_all 'spec/support'


DatabaseCleaner[:sequel].db = Sequel::Model.db

# Helper methods for creating test data.
module ModelHelpers
end

RSpec.configure do |config|
  config.before(:each) do
    Typhoeus::Expectation.clear
  end

  config.include RspecSequel::Matchers
  config.include Rack::Test::Methods
  config.include ModelHelpers

  config.before(:suite) do
    DatabaseCleaner.strategy = :transaction
    DatabaseCleaner.clean_with(:truncation)
  end

  config.around(:each) do |example|
    DatabaseCleaner.cleaning do
      example.run
    end
  end

  config.after(:all) do
    Dir.chdir(Dir.tmpdir) do
      temp_directories = Dir.glob('wpxf_*')
      unless temp_directories.empty?
        temp_directories.each { |d| FileUtils.rm_rf(d) }
      end
    end
  end
end
